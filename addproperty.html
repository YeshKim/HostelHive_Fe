<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Property - Hostel Hive</title>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-50: #f3f0ff;
        --primary-100: #e9e2ff;
        --primary-500: #8b5cf6;
        --primary-600: #7c3aed;
        --primary-700: #6d28d9;
        --primary-900: #4c1d95;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;
        --success-50: #ecfdf5;
        --success-500: #10b981;
        --success-600: #059669;
        --warning-50: #fffbeb;
        --warning-500: #f59e0b;
        --warning-600: #d97706;
        --error-50: #fef2f2;
        --error-500: #ef4444;
        --error-600: #dc2626;
        --info-50: #eff6ff;
        --info-500: #3b82f6;
        --info-600: #2563eb;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1),
          0 4px 6px -4px rgb(0 0 0 / 0.1);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1),
          0 8px 10px -6px rgb(0 0 0 / 0.1);
        --border-radius: 12px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        background: linear-gradient(
          135deg,
          var(--gray-50) 0%,
          var(--primary-50) 100%
        );
        color: var(--gray-800);
        line-height: 1.6;
        min-height: 100vh;
      }

      /* Header */
      header {
        background: linear-gradient(
          135deg,
          var(--primary-600) 0%,
          var(--primary-700) 100%
        );
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: var(--shadow-lg);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      nav {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 1.75rem;
        font-weight: 700;
        color: white;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .logo::before {
        content: "üè†";
        font-size: 1.5rem;
      }

      .nav-links {
        display: flex;
        list-style: none;
        gap: 2rem;
      }

      .nav-links a {
        color: rgba(255, 255, 255, 0.9);
        text-decoration: none;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: var(--transition);
        position: relative;
      }

      .nav-links a:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        transform: translateY(-1px);
      }

      .nav-links a.active {
        background: rgba(255, 255, 255, 0.2);
        color: white;
      }

      .user-profile {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .user-info {
        text-align: right;
        color: white;
      }

      .user-name {
        font-weight: 600;
        font-size: 0.9rem;
      }

      .user-role {
        font-size: 0.75rem;
        opacity: 0.8;
      }

      .profile-pic {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, white, var(--gray-100));
        color: var(--primary-600);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.1rem;
        box-shadow: var(--shadow-md);
        border: 2px solid rgba(255, 255, 255, 0.2);
      }

      .logout-btn {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        backdrop-filter: blur(10px);
      }

      .logout-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
      }

      /* Main Content */
      main {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 2rem;
      }

      .page-header {
        background: linear-gradient(135deg, white 0%, var(--gray-50) 100%);
        padding: 2.5rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
        border: 1px solid var(--gray-200);
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .page-header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(
          90deg,
          var(--primary-500),
          var(--primary-600),
          var(--primary-700)
        );
      }

      .page-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--gray-900);
        background: linear-gradient(
          135deg,
          var(--primary-600),
          var(--primary-700)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .page-header p {
        color: var(--gray-600);
        font-size: 1.1rem;
      }

      .breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        color: var(--gray-600);
        font-size: 0.9rem;
      }

      .breadcrumb a {
        color: var(--primary-500);
        text-decoration: none;
        transition: var(--transition);
      }

      .breadcrumb a:hover {
        color: var(--primary-600);
        text-decoration: underline;
      }

      /* Form Container */
      .form-container {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-200);
        overflow: hidden;
      }

      .form-header {
        background: linear-gradient(135deg, var(--gray-50), var(--gray-100));
        padding: 1.5rem;
        border-bottom: 1px solid var(--gray-200);
      }

      .form-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--gray-900);
      }

      .form-body {
        padding: 2rem;
      }

      .form-section {
        margin-bottom: 2rem;
      }

      .form-section h3 {
        color: var(--gray-900);
        margin-bottom: 1rem;
        font-size: 1.25rem;
        font-weight: 600;
        border-bottom: 2px solid var(--primary-500);
        padding-bottom: 0.5rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--gray-700);
        font-size: 0.9rem;
      }

      .form-group .required {
        color: var(--error-500);
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--gray-300);
        border-radius: 8px;
        font-size: 0.9rem;
        transition: var(--transition);
        background: white;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
      }

      .form-group textarea {
        resize: vertical;
        min-height: 120px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .form-row-triple {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1rem;
      }

      /* Enhanced Amenities Section */
      .amenities-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .amenity-card {
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: 10px;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        transition: var(--transition);
        position: relative;
        cursor: pointer;
      }

      .amenity-card:hover {
        background: var(--primary-50);
        border-color: var(--primary-500);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .amenity-card input[type="checkbox"] {
        display: none;
      }

      .amenity-card input[type="checkbox"]:checked + .amenity-content {
        background: var(--primary-100);
        border-color: var(--primary-500);
      }

      .amenity-card
        input[type="checkbox"]:checked
        + .amenity-content
        .amenity-icon {
        color: var(--primary-600);
      }

      .amenity-content {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        padding: 0.5rem;
        border-radius: 8px;
        transition: var(--transition);
      }

      .amenity-icon {
        font-size: 1.5rem;
        color: var(--gray-600);
        transition: var(--transition);
      }

      .amenity-label {
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--gray-800);
      }

      .amenity-tooltip {
        visibility: hidden;
        background: var(--gray-800);
        color: white;
        font-size: 0.8rem;
        padding: 0.5rem;
        border-radius: 6px;
        position: absolute;
        z-index: 1;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        width: 200px;
        text-align: center;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .amenity-card:hover .amenity-tooltip {
        visibility: visible;
        opacity: 1;
      }

      /* File Upload */
      .file-upload {
        border: 2px dashed var(--primary-500);
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        background: var(--primary-50);
        transition: var(--transition);
      }

      .file-upload:hover {
        background: var(--primary-100);
      }

      .file-upload input[type="file"] {
        display: none;
      }

      .file-upload label {
        cursor: pointer;
        color: var(--primary-600);
        font-weight: 600;
      }

      .file-upload .upload-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: var(--primary-600);
      }

      /* Image Preview */
      .image-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
      }

      /* Buttons */
      .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        font-size: 0.9rem;
        transition: var(--transition);
        box-shadow: var(--shadow-sm);
        white-space: nowrap;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary-500),
          var(--primary-600)
        );
        color: white;
        border: 1px solid var(--primary-600);
      }

      .btn-primary:hover {
        background: linear-gradient(
          135deg,
          var(--primary-600),
          var(--primary-700)
        );
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .btn-secondary {
        background: white;
        color: var(--gray-700);
        border: 1px solid var(--gray-300);
      }

      .btn-secondary:hover {
        background: var(--gray-50);
        border-color: var(--gray-400);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      /* Success Message */
      .success-message {
        background: var(--success-50);
        border: 1px solid var(--success-500);
        color: var(--success-600);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: none;
      }

      .success-message.show {
        display: block;
      }

      /* Error Message */
      .error-message {
        background: var(--error-50);
        border: 1px solid var(--error-500);
        color: var(--error-600);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      /* Loading Spinner */
      .spinner {
        border: 2px solid var(--gray-300);
        border-top: 2px solid var(--primary-500);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        display: none;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Rooms Details Section */
      .rooms-details {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-200);
        padding: 2rem;
        margin-top: 2rem;
        display: none;
      }

      .rooms-details.show {
        display: block;
      }

      .rooms-details h3 {
        color: var(--gray-900);
        margin-bottom: 1rem;
        font-size: 1.25rem;
        font-weight: 600;
        border-bottom: 2px solid var(--primary-500);
        padding-bottom: 0.5rem;
      }

      .rooms-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
      }

      .room-card {
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: 10px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        transition: var(--transition);
      }

      .room-card:hover {
        background: var(--primary-50);
        border-color: var(--primary-500);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .room-card span {
        font-size: 0.9rem;
        color: var(--gray-700);
      }

      .room-card .status-available {
        color: var(--success-600);
        font-weight: 600;
      }

      .room-card .status-unavailable {
        color: var(--error-600);
        font-weight: 600;
      }

      /* Responsive Design */
      @media (max-width: 1024px) {
        .form-row,
        .form-row-triple {
          grid-template-columns: 1fr;
        }

        .amenities-grid {
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .rooms-list {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        nav {
          padding: 1rem;
        }

        .nav-links {
          display: none;
        }

        .amenities-grid {
          grid-template-columns: 1fr;
        }

        .form-actions {
          flex-direction: column;
        }

        main {
          padding: 1rem;
        }

        .page-header {
          padding: 1.5rem;
        }

        .page-header h1 {
          font-size: 2rem;
        }
      }

      /* Accessibility */
      @media (prefers-reduced-motion: reduce) {
        * {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      button:focus,
      .btn:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3);
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header>
      <nav>
        <div class="logo">Hostel Hive</div>
        <ul class="nav-links">
          <li><a href="home-manager.html">Dashboard</a></li>
          <li><a href="#properties" class="active">Properties</a></li>
          <li><a href="bookings.html">Bookings</a></li>
          <li><a href="#payments">Payments</a></li>
        </ul>
        <div class="user-profile">
          <div class="user-info">
            <div class="user-name" id="userName">Loading...</div>
            <div class="user-role">Property Manager</div>
          </div>
          <div id="profilePic" class="profile-pic"></div>
          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </nav>
    </header>

    <!-- Main Content -->
    <main>
      <!-- Breadcrumb -->
      <nav class="breadcrumb">
        <a href="home-manager.html">Dashboard</a>
        <span>‚Üí</span>
        <a href="#properties">Properties</a>
        <span>‚Üí</span>
        <span>Add Property</span>
      </nav>

      <!-- Page Header -->
      <div class="page-header">
        <h1>Add New Property</h1>
        <p>List your hostel property and start earning with Hostel Hive</p>
      </div>

      <!-- Form Container -->
      <div class="form-container">
        <div class="form-header">
          <h2>Property Information</h2>
        </div>

        <div class="form-body">
          <div class="success-message" id="successMessage">
            <strong>Success!</strong> Your property and <span id="roomsCreatedCount">0</span> rooms have been submitted for review. You will be notified within 24 hours.
          </div>
          <div class="error-message" id="errorMessage">
            <strong>Error!</strong> <span id="errorText"></span>
          </div>

          <form id="addPropertyForm">
            <!-- Basic Information -->
            <div class="form-section">
              <h3>Basic Information</h3>
              <div class="form-group">
                <label for="propertyName">Property Name <span class="required">*</span></label>
                <input
                  type="text"
                  id="propertyName"
                  name="propertyName"
                  required
                  placeholder="Enter your property name (e.g., Strathmore Heights)"
                />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="location">Location <span class="required">*</span></label>
                  <select id="location" name="location" required>
                    <option value="">Select Location</option>
                    <option value="Madaraka, Nairobi">Madaraka, Nairobi</option>
                    <option value="Langata, Nairobi">Langata, Nairobi</option>
                    <option value="South B, Nairobi">South B, Nairobi</option>
                    <option value="Karen, Nairobi">Karen, Nairobi</option>
                    <option value="Kibera, Nairobi">Kibera, Nairobi</option>
                    <option value="Kasarani, Nairobi">Kasarani, Nairobi</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="propertyType">Property Type <span class="required">*</span></label>
                  <select id="propertyType" name="propertyType" required>
                    <option value="">Select Type</option>
                    <option value="boys">Boys Only</option>
                    <option value="girls">Girls Only</option>
                    <option value="mixed">Mixed</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label for="address">Full Address <span class="required">*</span></label>
                <textarea
                  id="address"
                  name="address"
                  required
                  placeholder="Enter complete address including street, building name, and landmarks"
                ></textarea>
              </div>
            </div>

            <!-- Room Details -->
            <div class="form-section">
              <h3>Room Details</h3>
              <div class="form-row-triple">
                <div class="form-group">
                  <label for="totalRooms">Total Rooms <span class="required">*</span></label>
                  <input
                    type="number"
                    id="totalRooms"
                    name="totalRooms"
                    min="1"
                    required
                    placeholder="e.g., 15"
                  />
                </div>
                <div class="form-group">
                  <label for="availableRooms">Available Rooms <span class="required">*</span></label>
                  <input
                    type="number"
                    id="availableRooms"
                    name="availableRooms"
                    min="0"
                    required
                    placeholder="e.g., 10"
                  />
                </div>
                <div class="form-group">
                  <label for="roomType">Room Type <span class="required">*</span></label>
                  <select id="roomType" name="roomType" required>
                    <option value="">Select Type</option>
                    <option value="single">Single Room</option>
                    <option value="shared">Shared Room</option>
                    <option value="both">Both Single & Shared</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="pricePerMonth">Price per Month (KSh) <span class="required">*</span></label>
                  <input
                    type="number"
                    id="pricePerMonth"
                    name="pricePerMonth"
                    min="0"
                    required
                    placeholder="e.g., 12000"
                  />
                </div>
                <div class="form-group">
                  <label for="depositAmount">Security Deposit (KSh)</label>
                  <input
                    type="number"
                    id="depositAmount"
                    name="depositAmount"
                    min="0"
                    placeholder="e.g., 5000"
                  />
                </div>
              </div>
            </div>

            <!-- Amenities -->
            <div class="form-section">
              <h3>Amenities <span class="required">*</span></h3>
              <div class="amenities-grid" id="amenitiesGrid">
                <!-- Amenities will be populated dynamically -->
              </div>
            </div>

            <!-- Property Description -->
            <div class="form-section">
              <h3>Property Description</h3>
              <div class="form-group">
                <label for="description">Detailed Description <span class="required">*</span></label>
                <textarea
                  id="description"
                  name="description"
                  required
                  placeholder="Describe your property in detail. Include information about the neighborhood, nearby universities, transportation, and what makes your hostel special."
                ></textarea>
              </div>
            </div>

            <!-- Property Images -->
            <div class="form-section">
              <h3>Property Images</h3>
              <div class="form-group">
                <label>Upload Property Photos</label>
                <div class="file-upload">
                  <div class="upload-icon">üì∏</div>
                  <label for="propertyImages">
                    <strong>Click to upload</strong> or drag and drop<br />
                    <small>PNG, JPG, JPEG up to 5MB each (Maximum 10 images)</small>
                  </label>
                  <input
                    type="file"
                    id="propertyImages"
                    name="propertyImages"
                    accept="image/png,image/jpeg,image/jpg"
                    multiple
                  />
                  <div class="image-preview" id="imagePreview"></div>
                </div>
              </div>
            </div>

            <!-- Contact Information -->
            <div class="form-section">
              <h3>Contact Information</h3>
              <div class="form-row">
                <div class="form-group">
                  <label for="contactPhone">Primary Phone <span class="required">*</span></label>
                  <input
                    type="tel"
                    id="contactPhone"
                    name="contactPhone"
                    required
                    placeholder="+254 7XX XXX XXX"
                    pattern="\+254[0-9]{9}"
                  />
                </div>
                <div class="form-group">
                  <label for="alternatePhone">Alternate Phone</label>
                  <input
                    type="tel"
                    id="alternatePhone"
                    name="alternatePhone"
                    placeholder="+254 7XX XXX XXX"
                    pattern="\+254[0-9]{9}"
                  />
                </div>
              </div>
              <div class="form-group">
                <label for="contactEmail">Email Address <span class="required">*</span></label>
                <input
                  type="email"
                  id="contactEmail"
                  name="contactEmail"
                  required
                  placeholder="your.email@example.com"
                />
              </div>
            </div>

            <!-- Terms and Conditions -->
            <div class="form-section">
              <div class="checkbox-group">
                <input type="checkbox" id="terms" name="terms" required />
                <label for="terms">
                  I agree to the
                  <a href="#" style="color: var(--primary-500)">Terms and Conditions</a>
                  and
                  <a href="#" style="color: var(--primary-500)">Privacy Policy</a>
                  <span class="required">*</span>
                </label>
              </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="window.location.href='home-manager.html'"
              >
                ‚Üê Back to Dashboard
              </button>
              <button type="submit" class="btn btn-primary">
                <div class="spinner" id="submitSpinner"></div>
                <span id="submitText">Submit Property</span>
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Rooms Details Section -->
      <div class="rooms-details" id="roomsDetails">
        <h3>Created Rooms</h3>
        <div class="rooms-list" id="roomsList"></div>
      </div>
    </main>

    <script>
      const API_BASE_URL = "http://localhost:8099";

      // Cache for amenities to avoid multiple API calls
      let cachedAmenities = null;

      // Helper to get JWT token from cookie
      function getToken() {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
          const [name, value] = cookie.trim().split("=");
          if (name === "jwtToken") {
            return value;
          }
        }
        return null;
      }

      // Axios instance with auth header
      const axiosInstance = axios.create({
        baseURL: API_BASE_URL,
        headers: { "Content-Type": "application/json" },
      });

      axiosInstance.interceptors.request.use((config) => {
        const token = getToken();
        if (token) {
          config.headers.Authorization = `Bearer ${token}`;
        }
        return config;
      });

      // Logout handler
      function logout() {
        document.cookie = "jwtToken=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT";
        window.location.href = "/login.html";
      }

      // Fetch user data
      async function fetchUserData() {
        try {
          const response = await axiosInstance.get("/users/me");
          const user = response.data;
          const userName = document.getElementById("userName");
          const profilePic = document.getElementById("profilePic");

          userName.textContent = user.fullName || "Manager";
          const initials = user.fullName
            ? user.fullName
                .split(" ")
                .map((n) => n[0])
                .join("")
                .substring(0, 2)
            : "M";
          profilePic.textContent = initials;
          return user;
        } catch (err) {
          console.error("Error fetching user:", err);
          showError("Session expired. Please log in again.");
          logout();
        }
      }

      // Fetch amenities and populate the amenities grid
      async function fetchAmenities() {
        try {
          const response = await axiosInstance.get("/api/amenities");
          const amenities = response.data;

          console.log("Amenities API response:", amenities);

          if (!Array.isArray(amenities) || amenities.length === 0) {
            console.warn("No amenities returned from API");
            showError("No amenities available. Please contact support.");
            loadFallbackAmenities();
            return;
          }

          const validAmenities = amenities.filter(
            (amenity) => amenity && amenity.name && typeof amenity.name === "string"
          );

          if (validAmenities.length === 0) {
            console.warn("No valid amenities found in response");
            showError("Invalid amenities data. Please contact support.");
            loadFallbackAmenities();
            return;
          }

          cachedAmenities = validAmenities;
          populateAmenitiesGrid(validAmenities);
        } catch (err) {
          console.error("Error fetching amenities:", err);
          showError("Failed to load amenities. Using default options.");
          loadFallbackAmenities();
        }
      }

      // Populate amenities grid
      function populateAmenitiesGrid(amenities) {
        const amenitiesGrid = document.getElementById("amenitiesGrid");
        amenitiesGrid.innerHTML = "";

        amenities.forEach((amenity) => {
          const amenityCard = `
            <label class="amenity-card">
              <input type="checkbox" name="amenities" value="${amenity.name}" />
              <div class="amenity-content">
                <span class="amenity-icon">${getAmenityIcon(amenity.name)}</span>
                <span class="amenity-label">${amenity.name}</span>
                <span class="amenity-tooltip">${getAmenityTooltip(amenity.name)}</span>
              </div>
            </label>
          `;
          amenitiesGrid.insertAdjacentHTML("beforeend", amenityCard);
        });
      }

      // Fallback amenities
      function loadFallbackAmenities() {
        const fallbackAmenities = [
          { name: "WiFi" },
          { name: "Parking" },
          { name: "Gym" },
          { name: "Kitchen" },
          { name: "Laundry" },
          { name: "Security" }
        ];
        populateAmenitiesGrid(fallbackAmenities);
      }

      // Map amenity names to icons
      function getAmenityIcon(name) {
        const icons = {
          WiFi: "üì∂",
          Parking: "üöó",
          Gym: "üèãÔ∏è",
          Kitchen: "üç≥",
          Laundry: "üßº",
          Security: "üîí",
          Water: "üíß",
          Electricity: "‚ö°Ô∏è",
          Furnished: "üõãÔ∏è",
          StudyRoom: "üìö",
          RecreationArea: "üéÆ",
          CCTV: "üìπ"
        };
        return icons[name] || "üè†";
      }

      // Map amenity names to tooltips
      function getAmenityTooltip(name) {
        const tooltips = {
          WiFi: "High-speed internet access throughout the property",
          Parking: "Dedicated parking spaces for residents",
          Gym: "On-site fitness center for residents",
          Kitchen: "Fully equipped kitchen for residents",
          Laundry: "On-site laundry facilities",
          Security: "Round-the-clock security personnel",
          Water: "Reliable water supply included",
          Electricity: "Stable power supply included",
          Furnished: "Fully furnished rooms with essential furniture",
          StudyRoom: "Dedicated quiet study areas",
          RecreationArea: "Common area for leisure and socializing",
          CCTV: "24/7 video surveillance for safety"
        };
        return tooltips[name] || `Includes ${name}`;
      }

      // Show error message
      function showError(message) {
        const errorMessage = document.getElementById("errorMessage");
        const errorText = document.getElementById("errorText");
        errorText.textContent = message;
        errorMessage.classList.add("show");
        setTimeout(() => {
          errorMessage.classList.remove("show");
        }, 5000);
      }

      // Reset form field borders
      function resetFormBorders() {
        const inputs = document.querySelectorAll(
          "#addPropertyForm input, #addPropertyForm select, #addPropertyForm textarea"
        );
        inputs.forEach((input) => {
          input.style.borderColor = "var(--gray-300)";
        });
      }

      // Populate rooms list
      function populateRoomsList(rooms) {
        const roomsList = document.getElementById("roomsList");
        roomsList.innerHTML = "";
        const roomsDetails = document.getElementById("roomsDetails");

        if (rooms.length === 0) {
          roomsDetails.classList.remove("show");
          return;
        }

        rooms.forEach((room) => {
          const roomCard = `
            <div class="room-card">
              <span><strong>Room Number:</strong> ${room.roomNumber}</span>
              <span><strong>Type:</strong> ${room.roomType}</span>
              <span><strong>Price:</strong> KSh ${room.price.toFixed(2)}</span>
              <span><strong>Status:</strong> <span class="${
                room.isAvailable ? "status-available" : "status-unavailable"
              }">${room.isAvailable ? "Available" : "Unavailable"}</span></span>
            </div>
          `;
          roomsList.insertAdjacentHTML("beforeend", roomCard);
        });

        roomsDetails.classList.add("show");
        window.scrollTo({ top: roomsDetails.offsetTop, behavior: "smooth" });
      }

      // Form Validation and Submission
      document
        .getElementById("addPropertyForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const submitBtn = this.querySelector('button[type="submit"]');
          const spinner = document.getElementById("submitSpinner");
          const submitText = document.getElementById("submitText");

          submitBtn.disabled = true;
          spinner.style.display = "block";
          submitText.textContent = "Submitting...";
          resetFormBorders();
          document.getElementById("roomsDetails").classList.remove("show");

          try {
            const formData = new FormData(this);

            const selectedAmenities = Array.from(
              document.querySelectorAll('input[name="amenities"]:checked')
            ).map((checkbox) => checkbox.value);

            if (!selectedAmenities.length) {
              showError("Please select at least one amenity");
              submitBtn.disabled = false;
              spinner.style.display = "none";
              submitText.textContent = "Submit Property";
              return;
            }

            if (cachedAmenities) {
              const validAmenityNames = cachedAmenities.map((amenity) => amenity.name);
              const invalidAmenities = selectedAmenities.filter(
                (name) => !validAmenityNames.includes(name)
              );
              if (invalidAmenities.length > 0) {
                showError(`Invalid amenities selected: ${invalidAmenities.join(", ")}`);
                submitBtn.disabled = false;
                spinner.style.display = "none";
                submitText.textContent = "Submit Property";
                return;
              }
            }

            const files = formData.getAll("propertyImages");
            const maxFiles = 10;
            const maxSize = 5 * 1024 * 1024;
            if (files.length > maxFiles) {
              showError(`Maximum ${maxFiles} images allowed`);
              submitBtn.disabled = false;
              spinner.style.display = "none";
              submitText.textContent = "Submit Property";
              return;
            }
            for (let file of files) {
              if (file.size > maxSize) {
                showError(`Each image must be less than 5MB`);
                submitBtn.disabled = false;
                spinner.style.display = "none";
                submitText.textContent = "Submit Property";
                return;
              }
            }

            const imagesBase64 = await Promise.all(
              Array.from(files).map((file) => {
                return new Promise((resolve, reject) => {
                  const reader = new FileReader();
                  reader.onload = () => resolve(reader.result);
                  reader.onerror = reject;
                  reader.readAsDataURL(file);
                });
              })
            );

            const totalRooms = parseInt(formData.get("totalRooms"));
            const availableRooms = parseInt(formData.get("availableRooms"));
            if (isNaN(totalRooms) || isNaN(availableRooms)) {
              showError("Total rooms and available rooms must be valid numbers");
              if (isNaN(totalRooms))
                document.getElementById("totalRooms").style.borderColor = "var(--error-500)";
              if (isNaN(availableRooms))
                document.getElementById("availableRooms").style.borderColor = "var(--error-500)";
              submitBtn.disabled = false;
              spinner.style.display = "none";
              submitText.textContent = "Submit Property";
              return;
            }
            if (availableRooms > totalRooms) {
              showError("Available rooms cannot exceed total rooms");
              document.getElementById("availableRooms").style.borderColor = "var(--error-500)";
              submitBtn.disabled = false;
              spinner.style.display = "none";
              submitText.textContent = "Submit Property";
              return;
            }

            const user = await fetchUserData();
            const managerId = user?.id ? parseInt(user.id) : null;
            if (!managerId) {
              showError("Unable to get manager ID. Please log in again.");
              logout();
              return;
            }

            const propertyData = {
              name: formData.get("propertyName"),
              address: formData.get("address"),
              location: formData.get("location"),
              pricePerMonth: parseFloat(formData.get("pricePerMonth")),
              managerId: managerId,
              propertyType: formData.get("propertyType"),
              roomType: formData.get("roomType"),
              totalRooms: totalRooms,
              availableRooms: availableRooms,
              depositAmount: formData.get("depositAmount")
                ? parseFloat(formData.get("depositAmount"))
                : null,
              amenities: selectedAmenities,
              description: formData.get("description"),
              contactPhone: formData.get("contactPhone"),
              alternatePhone: formData.get("alternatePhone") || null,
              contactEmail: formData.get("contactEmail"),
              imagesBase64: imagesBase64,
              isVerified: false,
              distance: 0.0,
            };

            console.log("Sending property data:", JSON.stringify(propertyData, null, 2));

            const response = await axiosInstance.post("/api/hostels/post-hostel", propertyData);

            // Fetch created rooms
            const hostelId = response.data.id;
            const roomsResponse = await axiosInstance.get(`/api/rooms/by-hostel/${hostelId}`);
            const rooms = roomsResponse.data;

            // Update success message with room count
            const successMessage = document.getElementById("successMessage");
            const roomsCreatedCount = document.getElementById("roomsCreatedCount");
            roomsCreatedCount.textContent = rooms.length;
            successMessage.classList.add("show");

            // Populate rooms list
            populateRoomsList(rooms);

            this.reset();
            document.getElementById("imagePreview").innerHTML = "";
            window.scrollTo({ top: 0, behavior: "smooth" });

            setTimeout(() => {
              successMessage.classList.remove("show");
            }, 5000);
          } catch (err) {
            let errorMessage = err.response?.data || "An error occurred while adding the property";
            if (typeof errorMessage === "object") {
              errorMessage = errorMessage.message || JSON.stringify(errorMessage);
            }

            if (err.response?.status === 400) {
              if (errorMessage.includes("Property name") || errorMessage.includes("name")) {
                document.getElementById("propertyName").style.borderColor = "var(--error-500)";
              }
              if (errorMessage.includes("Address") || errorMessage.includes("address")) {
                document.getElementById("address").style.borderColor = "var(--error-500)";
              }
              if (errorMessage.includes("Location") || errorMessage.includes("location")) {
                document.getElementById("location").style.borderColor = "var(--error-500)";
              }
              if (errorMessage.includes("price per month") || errorMessage.includes("pricePerMonth")) {
                document.getElementById("pricePerMonth").style.borderColor = "var(--error-500)";
              }
              if (errorMessage.includes("contact phone") || errorMessage.includes("contactPhone")) {
                document.getElementById("contactPhone").style.borderColor = "var(--error-500)";
              }
              if (errorMessage.includes("Manager ID") || errorMessage.includes("managerId")) {
                showError("Invalid manager ID. Please log in again.");
                logout();
                return;
              }
              if (errorMessage.includes("amenities are invalid")) {
                showError("One or more selected amenities are invalid. Please select valid amenities.");
                await fetchAmenities();
              } else {
                showError(errorMessage);
              }
            } else {
              showError(errorMessage);
            }
          } finally {
            submitBtn.disabled = false;
            spinner.style.display = "none";
            submitText.textContent = "Submit Property";
          }
        });

      // Auto-calculate available rooms when total rooms change
      document.getElementById("totalRooms").addEventListener("input", function () {
        const totalRooms = parseInt(this.value);
        const availableRoomsInput = document.getElementById("availableRooms");
        if (totalRooms > 0) {
          availableRoomsInput.max = totalRooms;
          if (parseInt(availableRoomsInput.value) > totalRooms) {
            availableRoomsInput.value = totalRooms;
          }
        }
      });

      // File upload preview
      document.getElementById("propertyImages").addEventListener("change", function (e) {
        const files = e.target.files;
        const uploadDiv = this.parentElement;
        const previewContainer = document.getElementById("imagePreview");
        previewContainer.innerHTML = "";

        if (files.length > 0) {
          const fileText = files.length === 1 ? "1 file selected" : `${files.length} files selected`;
          uploadDiv.querySelector("small").textContent = fileText;

          Array.from(files).forEach((file) => {
            const img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            img.style.width = "100px";
            img.style.height = "100px";
            img.style.objectFit = "cover";
            img.style.borderRadius = "8px";
            previewContainer.appendChild(img);
          });
        } else {
          uploadDiv.querySelector("small").textContent = "PNG, JPG, JPEG up to 5MB each (Maximum 10 images)";
        }
      });

      // Phone number formatting
      function formatPhoneNumber(input) {
        let value = input.value.replace(/\D/g, "");
        if (value.startsWith("254")) {
          value = "+" + value;
        } else if (value.startsWith("0")) {
          value = "+254" + value.substring(1);
        } else if (value.startsWith("7") || value.startsWith("1")) {
          value = "+254" + value;
        }
        input.value = value;
      }

      document.getElementById("contactPhone").addEventListener("blur", function () {
        formatPhoneNumber(this);
      });

      document.getElementById("alternatePhone").addEventListener("blur", function () {
        formatPhoneNumber(this);
      });

      // Initialize
      if (getToken()) {
        fetchUserData();
        fetchAmenities();
      } else {
        showError("No session found. Please log in.");
        window.location.href = "/login.html";
      }
    </script>
  </body>
</html>